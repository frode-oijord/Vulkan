<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>WebSocket Chat</title>
</head>

<body>
  <h1>WebSocket Chat</h1>
  Server URI: <input class="draw-border" id="uri" value="ws://localhost:8080">
  <button class="echo-button" id="connect">Connect</button>
  <button class="echo-button" id="disconnect">Disconnect</button><br>
  Your Name: <input class="draw-border" id="userName"><br>
  Connected Users:
  <pre id="userlist" style="width: 600px; border: solid 1px #cccccc; margin-bottom: 5px;"></pre>
  <pre id="messages" style="width: 600px; height: 400px; border: solid 1px #cccccc; margin-bottom: 5px;"></pre>

  Message <input class="draw-border" id="sendMessage" value="">
  <button class="echo-button" id="send">Send</button>
  <script>
    var ws = null;
    var users = [];

    addUser = function (userid) {
      users.push(userid);
    }

    removeUser = function (userid) {
      for (var i = 0; i < users.length; i++) {
        if (users[i] == userid) {
          users.splice(i, 1);
        }
      }
    }

    updateUserList = function () {
      userlist.innerText = "";
      Object.keys(users).forEach(key => {
        userlist.innerText += users[key] + "\n";
      });
    }

    connect.onclick = function () {
      ws = new WebSocket(uri.value);
      ws.onopen = function (ev) {
        var message = {
          type: "user-connected",
          userid: userName.value,
          content: "[user " + userName.value + " connected]\n",
        }
        ws.send(JSON.stringify(message));
        messages.innerText += message.content;
      };

      ws.onclose = function (ev) {
        messages.innerText += "remote connection closed...\n";
      };

      ws.onmessage = function (ev) {
        var message = JSON.parse(ev.data);
        if (message.type == "user-connected") {
          messages.innerText += message.content;
          addUser(message.userid);
          updateUserList();
        }
        else if (message.type == "user-disconnected") {
          removeUser(message.userid);
          updateUserList();
        }
        else if (message.type == "initialize-users") {
          users = message.users;
          updateUserList();
        }
        else if (message.type == "text") {
          messages.innerText += message.userid + ": " + message.content + "\n";
        }
      };

      ws.onerror = function (ev) {
        console.log(ev);
      };
    };

    disconnect.onclick = function () {
      var message = {
        type: "user-disconnected",
        userid: userName.value,
        content: "[user " + userName.value + " disconnected]\n",
      };
      ws.send(JSON.stringify(message));
      removeUser(message.userid);
      updateUserList();
      ws.close();
    };

    send.onclick = function () {
      var message = {
        type: "text",
        userid: userName.value,
        content: sendMessage.value,
      }
      ws.send(JSON.stringify(message));
      messages.innerText += message.userid + ": " + message.content + "\n";
      sendMessage.value = "";
    };

    sendMessage.onkeyup = function (ev) {
      ev.preventDefault();
      if (event.keyCode === 13) {
        send.click();
      }
    }
  </script>
</body>

</html>